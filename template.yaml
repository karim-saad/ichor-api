AWSTemplateFormatVersion: "2010-09-09"
Transform: AWS::Serverless-2016-10-31
Description: >
  SAM Template for Ichor Products

Parameters:
  Stage:
    Type: String
    Default: prod

Globals:
  Function:
    Runtime: python3.8
    Timeout: 120

Resources:
  ApiDeployment:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage

  ProductsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: products/
      FunctionName: products
      Handler: app.lambda_handler
      Events:
        GetProducts:
          Type: Api
          Properties:
            Path: /products
            Method: get
            RestApiId: !Ref ApiDeployment
        GetProduct:
          Type: Api
          Properties:
            Path: /product/{handle}
            Method: get
            RestApiId: !Ref ApiDeployment
      Policies:
        - DynamoDBReadPolicy: { TableName: products }

  CollectionsFunction:
    Type: AWS::Serverless::Function
    Properties:
      CodeUri: collections/
      FunctionName: collections
      Handler: app.lambda_handler
      Events:
        GetCollections:
          Type: Api
          Properties:
            Path: /collections
            Method: get
            RestApiId: !Ref ApiDeployment
        GetCollection:
          Type: Api
          Properties:
            Path: /collections/{handle}
            Method: get
            RestApiId: !Ref ApiDeployment
      Policies:
        - DynamoDBReadPolicy: { TableName: collections }

  ProductsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: products
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: handle
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: handle
          KeySchema:
            - AttributeName: handle
              KeyType: HASH
          Projection:
            ProjectionType: "ALL"

  CollectionsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: collections
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: id
          AttributeType: S
        - AttributeName: handle
          AttributeType: S
      KeySchema:
        - AttributeName: id
          KeyType: HASH
      GlobalSecondaryIndexes:
        - IndexName: handle
          KeySchema:
            - AttributeName: handle
              KeyType: HASH
          Projection:
            ProjectionType: "ALL"

  CollectionsProductsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: collections_products
      BillingMode: PAY_PER_REQUEST
      AttributeDefinitions:
        - AttributeName: collection_id
          AttributeType: S
      KeySchema:
        - AttributeName: collection_id
          KeyType: HASH
